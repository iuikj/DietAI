# DietAgentç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ—ï¸ ç³»ç»Ÿæ•´ä½“æ¶æ„

### æ¶æ„æ¦‚è§ˆ
é‡‡ç”¨**å¾®æœåŠ¡ + AI Agent + äº‹ä»¶é©±åŠ¨**çš„æ··åˆæ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Web App    â”‚ â”‚   å¾®ä¿¡ç«¯     â”‚ â”‚  ç®¡ç†åå°    â”‚            â”‚
â”‚  â”‚  (Vue3)     â”‚ â”‚ (UniApp)    â”‚ â”‚ (React)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIç½‘å…³å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 Nginx + Kong                            â”‚ â”‚
â”‚  â”‚        (è´Ÿè½½å‡è¡¡ã€è®¤è¯ã€é™æµã€æ—¥å¿—)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ ¸å¿ƒæœåŠ¡å±‚                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚  ç”¨æˆ·æœåŠ¡     â”‚ â”‚   AIåˆ†ææœåŠ¡  â”‚ â”‚   è®°å½•æœåŠ¡    â”‚           â”‚
â”‚ â”‚ (FastAPI)    â”‚ â”‚ (LangGraph)  â”‚ â”‚ (FastAPI)    â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚  å¥åº·è¯„ä¼°æœåŠ¡ â”‚ â”‚   æ¨èæœåŠ¡    â”‚ â”‚   é€šçŸ¥æœåŠ¡    â”‚           â”‚
â”‚ â”‚ (FastAPI)    â”‚ â”‚ (FastAPI)    â”‚ â”‚ (FastAPI)    â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ PostgreSQL   â”‚ â”‚    Redis     â”‚ â”‚    MinIO     â”‚           â”‚
â”‚ â”‚  (ä¸»æ•°æ®åº“)   â”‚ â”‚   (ç¼“å­˜)     â”‚ â”‚  (å¯¹è±¡å­˜å‚¨)   â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ ClickHouse   â”‚ â”‚   LangMem    â”‚ â”‚  Milvus      â”‚           â”‚
â”‚ â”‚ (è¡Œä¸ºåˆ†æ)    â”‚ â”‚ (é•¿æœŸè®°å¿†)    â”‚ â”‚ (å‘é‡æ•°æ®åº“)  â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š è¯¦ç»†æ•°æ®åº“è®¾è®¡

### 1. ç”¨æˆ·ç®¡ç†æ¨¡å—

```sql
-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255),
    salt VARCHAR(32),
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status INTEGER DEFAULT 1, -- 1:æ­£å¸¸ 0:ç¦ç”¨
    last_login_at TIMESTAMP
);

-- ç¬¬ä¸‰æ–¹ç™»å½•å…³è”è¡¨
CREATE TABLE user_oauth (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    provider VARCHAR(20) NOT NULL, -- wechat, qq, apple
    provider_user_id VARCHAR(100) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(provider, provider_user_id)
);

-- ç”¨æˆ·è¯¦ç»†ä¿¡æ¯è¡¨
CREATE TABLE user_profiles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) UNIQUE,
    real_name VARCHAR(50),
    gender INTEGER, -- 1:ç”· 2:å¥³ 0:æœªçŸ¥
    birth_date DATE,
    height DECIMAL(5,2), -- cm
    weight DECIMAL(5,2), -- kg
    bmi DECIMAL(4,2),
    activity_level INTEGER DEFAULT 2, -- 1:ä¹…å 2:è½»åº¦ 3:ä¸­åº¦ 4:é‡åº¦ 5:è¶…é‡åº¦
    occupation VARCHAR(100),
    region VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·å¥åº·ç›®æ ‡è¡¨
CREATE TABLE user_health_goals (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    goal_type INTEGER NOT NULL, -- 1:å‡é‡ 2:å¢é‡ 3:å¢è‚Œ 4:å‡è„‚ 5:ç–¾ç—…ç®¡ç† 6:ç»´æŒ
    target_weight DECIMAL(5,2),
    target_date DATE,
    current_status INTEGER DEFAULT 1, -- 1:è¿›è¡Œä¸­ 2:å·²å®Œæˆ 3:å·²æš‚åœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·ç–¾ç—…ä¿¡æ¯è¡¨
CREATE TABLE user_diseases (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    disease_code VARCHAR(20), -- ICD-10ç¼–ç 
    disease_name VARCHAR(100) NOT NULL,
    severity_level INTEGER, -- 1:è½»åº¦ 2:ä¸­åº¦ 3:é‡åº¦
    diagnosed_date DATE,
    is_current BOOLEAN DEFAULT TRUE,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è¿‡æ•ä¿¡æ¯è¡¨
CREATE TABLE user_allergies (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    allergen_type INTEGER, -- 1:é£Ÿç‰© 2:è¯ç‰© 3:ç¯å¢ƒ
    allergen_name VARCHAR(100) NOT NULL,
    severity_level INTEGER, -- 1:è½»å¾® 2:ä¸­åº¦ 3:ä¸¥é‡
    reaction_description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. é£Ÿç‰©è®°å½•æ¨¡å—

```sql
-- é£Ÿç‰©è®°å½•ä¸»è¡¨
CREATE TABLE food_records (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    record_date DATE NOT NULL,
    meal_type INTEGER NOT NULL, -- 1:æ—©é¤ 2:åˆé¤ 3:æ™šé¤ 4:åŠ é¤ 5:é›¶é£Ÿ
    food_name VARCHAR(200),
    description TEXT,
    image_url VARCHAR(255),
    image_analysis_result JSONB, -- AIåˆ†æçš„åŸå§‹ç»“æœ
    location_info JSONB, -- åœ°ç†ä½ç½®ä¿¡æ¯
    recording_method INTEGER DEFAULT 1, -- 1:æ‹ç…§ 2:æ‰‹åŠ¨è¾“å…¥ 3:è¯­éŸ³ 4:æ‰«ç 
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è¥å…»æˆåˆ†è¯¦æƒ…è¡¨
CREATE TABLE nutrition_details (
    id BIGSERIAL PRIMARY KEY,
    food_record_id BIGINT REFERENCES food_records(id),
    calories DECIMAL(8,2) DEFAULT 0, -- å¤§å¡
    protein DECIMAL(8,2) DEFAULT 0, -- è›‹ç™½è´¨(g)
    fat DECIMAL(8,2) DEFAULT 0, -- è„‚è‚ª(g)
    carbohydrates DECIMAL(8,2) DEFAULT 0, -- ç¢³æ°´åŒ–åˆç‰©(g)
    dietary_fiber DECIMAL(8,2) DEFAULT 0, -- è†³é£Ÿçº¤ç»´(g)
    sugar DECIMAL(8,2) DEFAULT 0, -- ç³–(g)
    sodium DECIMAL(8,2) DEFAULT 0, -- é’ (mg)
    cholesterol DECIMAL(8,2) DEFAULT 0, -- èƒ†å›ºé†‡(mg)
    vitamin_a DECIMAL(8,2) DEFAULT 0, -- ç»´ç”Ÿç´ A(Î¼g)
    vitamin_c DECIMAL(8,2) DEFAULT 0, -- ç»´ç”Ÿç´ C(mg)
    vitamin_d DECIMAL(8,2) DEFAULT 0, -- ç»´ç”Ÿç´ D(Î¼g)
    calcium DECIMAL(8,2) DEFAULT 0, -- é’™(mg)
    iron DECIMAL(8,2) DEFAULT 0, -- é“(mg)
    potassium DECIMAL(8,2) DEFAULT 0, -- é’¾(mg)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ¯æ—¥æ±‡æ€»è¡¨
CREATE TABLE daily_nutrition_summary (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    summary_date DATE NOT NULL,
    total_calories DECIMAL(8,2) DEFAULT 0,
    total_protein DECIMAL(8,2) DEFAULT 0,
    total_fat DECIMAL(8,2) DEFAULT 0,
    total_carbohydrates DECIMAL(8,2) DEFAULT 0,
    total_fiber DECIMAL(8,2) DEFAULT 0,
    total_sodium DECIMAL(8,2) DEFAULT 0,
    meal_count INTEGER DEFAULT 0,
    water_intake DECIMAL(6,2) DEFAULT 0, -- é¥®æ°´é‡(L)
    exercise_calories DECIMAL(8,2) DEFAULT 0, -- è¿åŠ¨æ¶ˆè€—
    health_score DECIMAL(4,2), -- å½“æ—¥å¥åº·è¯„åˆ†
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, summary_date)
);

-- ä½“é‡è®°å½•è¡¨
CREATE TABLE weight_records (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    weight DECIMAL(5,2) NOT NULL,
    body_fat_percentage DECIMAL(4,2), -- ä½“è„‚ç‡
    muscle_mass DECIMAL(5,2), -- è‚Œè‚‰é‡
    bmi DECIMAL(4,2),
    measured_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notes TEXT,
    device_type VARCHAR(50) -- æµ‹é‡è®¾å¤‡ç±»å‹
);
```

### 3. AIå¯¹è¯ä¸è®°å¿†æ¨¡å—

```sql
-- å¯¹è¯ä¼šè¯è¡¨
CREATE TABLE conversation_sessions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    session_type INTEGER DEFAULT 1, -- 1:è¥å…»å’¨è¯¢ 2:é£Ÿç‰©è¯†åˆ« 3:å¥åº·å»ºè®® 4:é£Ÿè°±æ¨è
    langgraph_thread_id VARCHAR(100) UNIQUE,
    langgraph_assistant_id VARCHAR(100),
    title VARCHAR(200),
    status INTEGER DEFAULT 1, -- 1:æ´»è·ƒ 2:å·²ç»“æŸ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_message_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ¶ˆæ¯è®°å½•è¡¨
CREATE TABLE conversation_messages (
    id BIGSERIAL PRIMARY KEY,
    session_id BIGINT REFERENCES conversation_sessions(id),
    message_type INTEGER NOT NULL, -- 1:ç”¨æˆ·æ¶ˆæ¯ 2:AIå›å¤ 3:ç³»ç»Ÿæ¶ˆæ¯
    content TEXT NOT NULL,
    metadata JSONB, -- é™„åŠ ä¿¡æ¯ï¼Œå¦‚å›¾ç‰‡ã€ä½ç½®ç­‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·åå¥½è®¾ç½®è¡¨
CREATE TABLE user_preferences (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) UNIQUE,
    dietary_restrictions JSONB, -- é¥®é£Ÿé™åˆ¶ ["vegetarian", "halal", "kosher"]
    disliked_foods JSONB, -- ä¸å–œæ¬¢çš„é£Ÿç‰©
    preferred_cuisines JSONB, -- åå¥½èœç³»
    spice_tolerance INTEGER DEFAULT 3, -- è¾£åº¦è€å— 1-5
    notification_settings JSONB, -- é€šçŸ¥è®¾ç½®
    privacy_settings JSONB, -- éšç§è®¾ç½®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é•¿æœŸè®°å¿†ç®¡ç†è¡¨ (ä¸LangMemé›†æˆ)
CREATE TABLE user_memory_contexts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    memory_type INTEGER, -- 1:é¥®é£Ÿä¹ æƒ¯ 2:å¥åº·çŠ¶æ€ 3:åå¥½è®°å½• 4:è¡Œä¸ºæ¨¡å¼
    context_key VARCHAR(100),
    context_value JSONB,
    importance_score DECIMAL(3,2), -- é‡è¦æ€§è¯„åˆ† 0-1
    last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP, -- è®°å¿†è¿‡æœŸæ—¶é—´
    INDEX(user_id, memory_type, importance_score)
);
```

### 4. çŸ¥è¯†åº“ä¸æ¨èæ¨¡å—

```sql
-- é£Ÿç‰©åŸºç¡€çŸ¥è¯†åº“
CREATE TABLE food_database (
    id BIGSERIAL PRIMARY KEY,
    food_code VARCHAR(20) UNIQUE, -- é£Ÿç‰©ç¼–ç 
    food_name VARCHAR(200) NOT NULL,
    food_name_en VARCHAR(200),
    category_id INTEGER,
    subcategory_id INTEGER,
    brand VARCHAR(100),
    serving_size DECIMAL(6,2), -- æ ‡å‡†ä»½é‡(g)
    calories_per_100g DECIMAL(8,2),
    protein_per_100g DECIMAL(8,2),
    fat_per_100g DECIMAL(8,2),
    carb_per_100g DECIMAL(8,2),
    fiber_per_100g DECIMAL(8,2),
    sodium_per_100g DECIMAL(8,2),
    nutrition_grade CHAR(1), -- A-Eè¥å…»ç­‰çº§
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç–¾ç—…-è¥å…»ç´ å…³è”è¡¨
CREATE TABLE disease_nutrition_relations (
    id BIGSERIAL PRIMARY KEY,
    disease_code VARCHAR(20),
    nutrient_name VARCHAR(50),
    relation_type INTEGER, -- 1:éœ€è¦æ§åˆ¶ 2:éœ€è¦å¢åŠ  3:éœ€è¦é¿å…
    recommended_daily_amount DECIMAL(8,2),
    max_daily_amount DECIMAL(8,2),
    warning_threshold DECIMAL(8,2),
    description TEXT,
    evidence_level INTEGER -- 1-5 è¯æ®ç­‰çº§
);

-- ä¸ªæ€§åŒ–æ¨èè®°å½•è¡¨
CREATE TABLE personalized_recommendations (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    recommendation_type INTEGER, -- 1:é£Ÿç‰©æ¨è 2:é£Ÿè°±æ¨è 3:è¿åŠ¨å»ºè®® 4:å¥åº·æé†’
    content JSONB,
    reason TEXT, -- æ¨èç†ç”±
    priority_score DECIMAL(3,2), -- ä¼˜å…ˆçº§è¯„åˆ†
    status INTEGER DEFAULT 1, -- 1:å¾…å¤„ç† 2:å·²æŸ¥çœ‹ 3:å·²é‡‡çº³ 4:å·²å¿½ç•¥
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ­ å¾®æœåŠ¡æ¶æ„è®¾è®¡

### 1. ç”¨æˆ·æœåŠ¡ (User Service)
```python
# user_service/main.py
from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from . import models, schemas, crud, auth

app = FastAPI(title="ç”¨æˆ·æœåŠ¡", version="1.0.0")

@app.post("/register", response_model=schemas.UserResponse)
async def register_user(user: schemas.UserCreate, db: Session = Depends(get_db)):
    """ç”¨æˆ·æ³¨å†Œ"""
    pass

@app.post("/login", response_model=schemas.TokenResponse)
async def login(credentials: schemas.LoginCredentials, db: Session = Depends(get_db)):
    """ç”¨æˆ·ç™»å½•"""
    pass

@app.post("/oauth/{provider}")
async def oauth_login(provider: str, oauth_data: schemas.OAuthData):
    """ç¬¬ä¸‰æ–¹ç™»å½•"""
    pass

@app.get("/profile", response_model=schemas.UserProfile)
async def get_profile(current_user: models.User = Depends(get_current_user)):
    """è·å–ç”¨æˆ·èµ„æ–™"""
    pass

@app.put("/profile")
async def update_profile(profile: schemas.UserProfileUpdate, 
                        current_user: models.User = Depends(get_current_user)):
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
    pass
```

### 2. AIåˆ†ææœåŠ¡ (AI Analysis Service)
```python
# ai_service/main.py
from fastapi import FastAPI, UploadFile, File, Depends
from langchain_community.chat_models import ChatOpenAI
from langgraph.graph import StateGraph
from . import agents, states, tools

app = FastAPI(title="AIåˆ†ææœåŠ¡", version="1.0.0")

@app.post("/analyze/image")
async def analyze_food_image(
    file: UploadFile = File(...),
    user_context: dict = Depends(get_user_context)
):
    """é£Ÿç‰©å›¾ç‰‡åˆ†æ"""
    # ä½¿ç”¨ä½ ç°æœ‰çš„LangGraphå®ç°
    pass

@app.post("/chat/nutrition")
async def nutrition_chat(
    message: str,
    session_id: str,
    user_context: dict = Depends(get_user_context)
):
    """è¥å…»å’¨è¯¢å¯¹è¯"""
    pass

@app.post("/recommend/meals")
async def recommend_meals(
    user_id: int,
    preferences: dict,
    health_goals: list
):
    """ä¸ªæ€§åŒ–è†³é£Ÿæ¨è"""
    pass

@app.post("/analyze/health-trends")
async def analyze_health_trends(user_id: int, days: int = 30):
    """å¥åº·è¶‹åŠ¿åˆ†æ"""
    pass
```

### 3. è®°å½•æœåŠ¡ (Record Service)
```python
# record_service/main.py
from fastapi import FastAPI, Depends, BackgroundTasks
from . import models, schemas, crud

app = FastAPI(title="è®°å½•æœåŠ¡", version="1.0.0")

@app.post("/food-records", response_model=schemas.FoodRecordResponse)
async def create_food_record(
    record: schemas.FoodRecordCreate,
    background_tasks: BackgroundTasks,
    current_user: models.User = Depends(get_current_user)
):
    """åˆ›å»ºé£Ÿç‰©è®°å½•"""
    # ä¿å­˜è®°å½•åˆ°æ•°æ®åº“
    # å¼‚æ­¥è§¦å‘è¥å…»åˆ†æ
    background_tasks.add_task(analyze_nutrition, record.id)
    pass

@app.get("/food-records")
async def get_food_records(
    date_from: date = None,
    date_to: date = None,
    meal_type: int = None,
    current_user: models.User = Depends(get_current_user)
):
    """è·å–é£Ÿç‰©è®°å½•"""
    pass

@app.post("/weight-records")
async def create_weight_record(
    weight_data: schemas.WeightRecordCreate,
    current_user: models.User = Depends(get_current_user)
):
    """è®°å½•ä½“é‡"""
    pass

@app.get("/daily-summary/{date}")
async def get_daily_summary(
    date: date,
    current_user: models.User = Depends(get_current_user)
):
    """è·å–æ¯æ—¥è¥å…»æ±‡æ€»"""
    pass
```

### 4. å¥åº·è¯„ä¼°æœåŠ¡ (Health Assessment Service)
```python
# health_service/main.py
from fastapi import FastAPI, Depends
from . import calculators, analyzers

app = FastAPI(title="å¥åº·è¯„ä¼°æœåŠ¡", version="1.0.0")

@app.post("/calculate/bmr")
async def calculate_bmr(user_data: schemas.UserBasicInfo):
    """è®¡ç®—åŸºç¡€ä»£è°¢ç‡"""
    pass

@app.post("/calculate/tdee")
async def calculate_tdee(user_data: schemas.UserBasicInfo, activity_level: int):
    """è®¡ç®—æ¯æ—¥æ€»èƒ½é‡æ¶ˆè€—"""
    pass

@app.post("/assess/health-score")
async def assess_health_score(
    user_id: int,
    analysis_period: int = 7  # å¤©æ•°
):
    """è®¡ç®—å¥åº·è¯„åˆ†"""
    pass

@app.post("/analyze/nutrition-balance")
async def analyze_nutrition_balance(user_id: int, date: date):
    """åˆ†æè¥å…»å¹³è¡¡åº¦"""
    pass

@app.get("/recommendations/daily-targets")
async def get_daily_targets(user_id: int):
    """è·å–æ¯æ—¥è¥å…»ç›®æ ‡"""
    pass
```

## ğŸ”§ æŠ€æœ¯æ ˆè¯¦ç»†è§„åˆ’

### åç«¯æŠ€æœ¯æ ˆ
```yaml
æ ¸å¿ƒæ¡†æ¶:
  - FastAPI: Webæ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥å’Œè‡ªåŠ¨APIæ–‡æ¡£
  - LangGraph: AI Agentå·¥ä½œæµå¼•æ“
  - SQLAlchemy: ORMæ¡†æ¶
  - Alembic: æ•°æ®åº“è¿ç§»å·¥å…·

æ•°æ®å­˜å‚¨:
  - PostgreSQL: ä¸»æ•°æ®åº“
  - Redis: ç¼“å­˜å’Œä¼šè¯å­˜å‚¨
  - MinIO: å¯¹è±¡å­˜å‚¨(å›¾ç‰‡ã€æ–‡ä»¶)
  - ClickHouse: è¡Œä¸ºåˆ†ææ•°æ®ä»“åº“
  - Milvus: å‘é‡æ•°æ®åº“(è¯­ä¹‰æœç´¢)

AIç›¸å…³:
  - LangChain: LLMæ¡†æ¶
  - LangMem: é•¿æœŸè®°å¿†ç®¡ç†
  - OpenAI/Qwen: å¤šæ¨¡æ€æ¨¡å‹
  - Transformers: æœ¬åœ°æ¨¡å‹æ¨ç†

æ¶ˆæ¯é˜Ÿåˆ—:
  - RabbitMQ: å¼‚æ­¥ä»»åŠ¡å¤„ç†
  - Celery: åå°ä»»åŠ¡æ‰§è¡Œ

ç›‘æ§è¿ç»´:
  - Prometheus: æŒ‡æ ‡ç›‘æ§
  - Grafana: å¯è§†åŒ–é¢æ¿
  - ELK Stack: æ—¥å¿—åˆ†æ
  - Jaeger: é“¾è·¯è¿½è¸ª
```

### å‰ç«¯æŠ€æœ¯æ ˆ
```yaml
Webç«¯:
  - Vue 3 + TypeScript
  - Vite: æ„å»ºå·¥å…·
  - Pinia: çŠ¶æ€ç®¡ç†
  - Vue Router: è·¯ç”±ç®¡ç†
  - Element Plus: UIç»„ä»¶åº“
  - ECharts: æ•°æ®å¯è§†åŒ–

ç§»åŠ¨ç«¯:
  - UniApp: è·¨å¹³å°å¼€å‘
  - Vue 3 + TypeScript
  - uni-ui: ç»„ä»¶åº“

ç®¡ç†åå°:
  - React 18 + TypeScript
  - Next.js: å…¨æ ˆæ¡†æ¶
  - Ant Design: UIç»„ä»¶åº“
  - React Query: æ•°æ®è·å–
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### Docker Compose é…ç½®ä¼˜åŒ–
```yaml
# docker-compose.yml
version: '3.8'

services:
  # APIç½‘å…³
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - user-service
      - ai-service
      - record-service
      - health-service

  # ç”¨æˆ·æœåŠ¡
  user-service:
    build: ./services/user_service
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/dietagent
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  # AIåˆ†ææœåŠ¡
  ai-service:
    build: ./services/ai_service
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QWEN_API_KEY=${QWEN_API_KEY}
      - MILVUS_URI=milvus:19530
    depends_on:
      - milvus
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # è®°å½•æœåŠ¡
  record-service:
    build: ./services/record_service
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/dietagent
      - MINIO_ENDPOINT=minio:9000
    depends_on:
      - postgres
      - minio

  # å¥åº·è¯„ä¼°æœåŠ¡
  health-service:
    build: ./services/health_service
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432
      - CLICKHOUSE_URL=clickhouse://clickhouse:8123
    depends_on:
      - postgres
      - clickhouse

  # æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: dietagent
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/

  # ç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # å¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  # å‘é‡æ•°æ®åº“
  milvus:
    image: milvusdb/milvus:latest
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    ports:
      - "19530:19530"
    depends_on:
      - etcd
      - minio

  # è¡Œä¸ºåˆ†ææ•°æ®åº“
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123"
      - "9009:9009"
    volumes:
      - clickhouse_data:/var/lib/clickhouse

  # æ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # åå°ä»»åŠ¡å¤„ç†
  celery-worker:
    build: ./services/shared
    command: celery -A tasks worker --loglevel=info
    environment:
      - CELERY_BROKER_URL=amqp://admin:password@rabbitmq:5672//
      - DATABASE_URL=postgresql://user:pass@postgres:5432/dietagent
    depends_on:
      - rabbitmq
      - postgres

volumes:
  postgres_data:
  redis_data:
  minio_data:
  clickhouse_data:
  rabbitmq_data:
```

## ğŸ“± åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡

### 1. ç”¨æˆ·ä¸ªæ€§åŒ–å¥åº·è§„åˆ™å¼•æ“

```python
# health_rules_engine.py
class HealthRulesEngine:
    def __init__(self):
        self.rules = {}
        
    def create_personalized_rules(self, user_profile: UserProfile):
        """æ ¹æ®ç”¨æˆ·ä¿¡æ¯åˆ›å»ºä¸ªæ€§åŒ–è§„åˆ™"""
        rules = []
        
        # åŸºäºç–¾ç—…çš„è§„åˆ™
        for disease in user_profile.diseases:
            rules.extend(self._create_disease_rules(disease))
        
        # åŸºäºç›®æ ‡çš„è§„åˆ™
        if user_profile.goal_type == GoalType.WEIGHT_LOSS:
            rules.extend(self._create_weight_loss_rules(user_profile))
        
        # åŸºäºè¿‡æ•çš„è§„åˆ™
        for allergy in user_profile.allergies:
            rules.extend(self._create_allergy_rules(allergy))
            
        return rules
    
    def evaluate_food_item(self, food_item: FoodItem, user_rules: List[Rule]):
        """è¯„ä¼°é£Ÿç‰©æ˜¯å¦ç¬¦åˆç”¨æˆ·å¥åº·è§„åˆ™"""
        score = 10.0  # åŸºç¡€åˆ†æ•°
        warnings = []
        
        for rule in user_rules:
            result = rule.evaluate(food_item)
            score += result.score_adjustment
            if result.warning:
                warnings.append(result.warning)
        
        return HealthEvaluation(score=score, warnings=warnings)
```

### 2. æ™ºèƒ½è¥å…»åˆ†æä¸å»ºè®®ç”Ÿæˆ

```python
# nutrition_analyzer.py
class NutritionAnalyzer:
    def __init__(self, llm_model, user_context):
        self.llm = llm_model
        self.user_context = user_context
        
    async def analyze_meal_composition(self, food_items: List[FoodItem]):
        """åˆ†æé¤é£Ÿç»„æˆå’Œè¥å…»å¹³è¡¡"""
        
        # è®¡ç®—æ€»è¥å…»æˆåˆ†
        total_nutrition = self._calculate_total_nutrition(food_items)
        
        # è¯„ä¼°è¥å…»å¹³è¡¡
        balance_score = self._evaluate_nutrition_balance(total_nutrition)
        
        # ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
        recommendations = await self._generate_recommendations(
            total_nutrition, balance_score
        )
        
        return NutritionAnalysis(
            total_nutrition=total_nutrition,
            balance_score=balance_score,
            recommendations=recommendations
        )
    
    async def _generate_recommendations(self, nutrition, balance_score):
        """ä½¿ç”¨LLMç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®"""
        prompt = f"""
        ç”¨æˆ·ä¿¡æ¯ï¼š{self.user_context}
        æœ¬é¤è¥å…»æˆåˆ†ï¼š{nutrition}
        è¥å…»å¹³è¡¡è¯„åˆ†ï¼š{balance_score}
        
        è¯·æä¾›ä¸“ä¸šçš„è¥å…»å»ºè®®ï¼ŒåŒ…æ‹¬ï¼š
        1. æœ¬é¤çš„ä¼˜ç‚¹å’Œä¸è¶³
        2. ä¸‹ä¸€é¤çš„å»ºè®®è°ƒæ•´
        3. é•¿æœŸé¥®é£Ÿå»ºè®®
        4. ç‰¹å®šäººç¾¤æ³¨æ„äº‹é¡¹
        """
        
        response = await self.llm.ainvoke(prompt)
        return self._parse_recommendations(response.content)
```

### 3. é•¿æœŸè®°å¿†ç®¡ç†ä¸ä¸Šä¸‹æ–‡ç»´æŠ¤

```python
# memory_manager.py
from langmem import LangMem

class UserMemoryManager:
    def __init__(self, user_id: int):
        self.user_id = user_id
        self.memory = LangMem(
            namespace=f"user_{user_id}",
            storage_backend="postgresql://...",
            vector_store="milvus://..."
        )
    
    async def update_dietary_habits(self, food_record: FoodRecord):
        """æ›´æ–°ç”¨æˆ·é¥®é£Ÿä¹ æƒ¯è®°å¿†"""
        
        # æå–å…³é”®ä¿¡æ¯
        habits = {
            "preferred_meal_times": self._extract_meal_timing(food_record),
            "food_preferences": self._extract_food_preferences(food_record),
            "portion_sizes": self._extract_portion_patterns(food_record),
            "cooking_methods": self._extract_cooking_preferences(food_record)
        }
        
        # å­˜å‚¨åˆ°é•¿æœŸè®°å¿†
        await self.memory.store(
            key="dietary_habits",
            content=habits,
            importance=0.8,
            decay_rate=0.1  # ç¼“æ…¢è¡°å‡
        )
    
    async def get_personalized_context(self) -> dict:
        """è·å–ç”¨æˆ·ä¸ªæ€§åŒ–ä¸Šä¸‹æ–‡"""
        
        # æ£€ç´¢ç›¸å…³è®°å¿†
        dietary_habits = await self.memory.retrieve("dietary_habits")
        health_trends = await self.memory.retrieve("health_trends")
        preferences = await self.memory.retrieve("preferences")
        
        return {
            "dietary_habits": dietary_habits,
            "health_trends": health_trends,
            "preferences": preferences,
            "last_updated": datetime.now()
        }
```

### 4. å¥åº·åº¦è¯„ä¼°ç®—æ³•

```python
# health_scorer.py
class HealthScorer:
    def __init__(self):
        self.weights = {
            "nutrition_balance": 0.3,
            "calorie_balance": 0.2,
            "food_variety": 0.15,
            "meal_timing": 0.1,
            "hydration": 0.1,
            "exercise_correlation": 0.1,
            "consistency": 0.05
        }
    
    def calculate_daily_health_score(self, user_id: int, date: date) -> float:
        """è®¡ç®—æ¯æ—¥å¥åº·è¯„åˆ†"""
        
        scores = {}
        
        # è¥å…»å¹³è¡¡è¯„åˆ†
        scores["nutrition_balance"] = self._score_nutrition_balance(user_id, date)
        
        # çƒ­é‡å¹³è¡¡è¯„åˆ†
        scores["calorie_balance"] = self._score_calorie_balance(user_id, date)
        
        # é£Ÿç‰©å¤šæ ·æ€§è¯„åˆ†
        scores["food_variety"] = self._score_food_variety(user_id, date)
        
        # ç”¨é¤æ—¶é—´è§„å¾‹æ€§è¯„åˆ†
        scores["meal_timing"] = self._score_meal_timing(user_id, date)
        
        # æ°´åˆ†æ‘„å…¥è¯„åˆ†
        scores["hydration"] = self._score_hydration(user_id, date)
        
        # è¿åŠ¨ç›¸å…³æ€§è¯„åˆ†
        scores["exercise_correlation"] = self._score_exercise_correlation(user_id, date)
        
        # é¥®é£Ÿä¸€è‡´æ€§è¯„åˆ†ï¼ˆ7å¤©å†…ï¼‰
        scores["consistency"] = self._score_consistency(user_id, date, days=7)
        
        # åŠ æƒè®¡ç®—æ€»åˆ†
        total_score = sum(score * self.weights[key] for key, score in scores.items())
        
        return min(10.0, max(0.0, total_score))
    
    def calculate_trend_health_score(self, user_id: int, days: int = 30) -> dict:
        """è®¡ç®—å¥åº·è¶‹åŠ¿è¯„åˆ†"""
        
        daily_scores = []
        for i in range(days):
            date = datetime.now().date() - timedelta(days=i)
            score = self.calculate_daily_health_score(user_id, date)
            daily_scores.append(score)
        
        return {
            "current_score": daily_scores[0],
            "average_score": sum(daily_scores) / len(daily_scores),
            "trend": self._calculate_trend(daily_scores),
            "improvement_suggestions": self._generate_improvement_suggestions(daily_scores)
        }
```

## ğŸ”’ å®‰å…¨æ€§ä¸éšç§ä¿æŠ¤

### 1. æ•°æ®å®‰å…¨
```python
# security.py
from cryptography.fernet import Fernet
import hashlib

class SecurityManager:
    def __init__(self):
        self.encryption_key = Fernet.generate_key()
        self.cipher = Fernet(self.encryption_key)
    
    def encrypt_sensitive_data(self, data: str) -> str:
        """åŠ å¯†æ•æ„Ÿæ•°æ®"""
        return self.cipher.encrypt(data.encode()).decode()
    
    def hash_password(self, password: str, salt: str) -> str:
        """å¯†ç å“ˆå¸Œ"""
        return hashlib.pbkdf2_hmac('sha256', 
                                  password.encode(), 
                                  salt.encode(), 
                                  100000).hex()
    
    def anonymize_user_data(self, user_data: dict) -> dict:
        """ç”¨æˆ·æ•°æ®åŒ¿ååŒ–"""
        sensitive_fields = ['name', 'email', 'phone']
        anonymized = user_data.copy()
        
        for field in sensitive_fields:
            if field in anonymized:
                anonymized[field] = self._generate_anonymous_id()
        
        return anonymized
```

### 2. APIå®‰å…¨
```python
# api_security.py
from fastapi_limiter import FastAPILimiter
from fastapi_limiter.depends import RateLimiter

@app.middleware("http")
async def security_headers_middleware(request: Request, call_next):
    """æ·»åŠ å®‰å…¨å¤´"""
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    return response

@app.post("/api/sensitive-endpoint")
@limiter.limit("5/minute")  # é™æµ
async def sensitive_endpoint(
    request: Request,
    current_user: User = Depends(get_current_user_with_2fa)  # åŒå› å­è®¤è¯
):
    pass
```

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### 1. ç³»ç»Ÿç›‘æ§
```python
# monitoring.py
from prometheus_client import Counter, Histogram, Gauge
import time

# å®šä¹‰æŒ‡æ ‡
REQUEST_COUNT = Counter('http_requests_total', 'Total HTTP requests', ['method', 'endpoint'])
REQUEST_DURATION = Histogram('http_request_duration_seconds', 'HTTP request duration')
ACTIVE_USERS = Gauge('active_users_total', 'Number of active users')

@app.middleware("http")
async def monitoring_middleware(request: Request, call_next):
    """ç›‘æ§ä¸­é—´ä»¶"""
    start_time = time.time()
    
    response = await call_next(request)
    
    # è®°å½•æŒ‡æ ‡
    REQUEST_COUNT.labels(
        method=request.method,
        endpoint=request.url.path
    ).inc()
    
    REQUEST_DURATION.observe(time.time() - start_time)
    
    return response
```

### 2. å¥åº·æ£€æŸ¥
```python
# health_check.py
@app.get("/health")
async def health_check():
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    checks = {
        "database": await check_database_connection(),
        "redis": await check_redis_connection(),
        "minio": await check_minio_connection(),
        "ai_service": await check_ai_service(),
        "memory_service": await check_memory_service()
    }
    
    all_healthy = all(checks.values())
    
    return {
        "status": "healthy" if all_healthy else "unhealthy",
        "checks": checks,
        "timestamp": datetime.now().isoformat()
    }
```

## ğŸš€ å®æ–½è·¯çº¿å›¾

### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ (4-6å‘¨)
1. âœ… ç”¨æˆ·æ³¨å†Œç™»å½•ç³»ç»Ÿ
2. âœ… å›¾ç‰‡ä¸Šä¼ å’ŒAIåˆ†æ
3. âœ… åŸºç¡€è¥å…»è®°å½•åŠŸèƒ½
4. âœ… ç®€å•çš„å¥åº·è¯„åˆ†

### é˜¶æ®µ2ï¼šæ™ºèƒ½åŒ–å¢å¼º (6-8å‘¨)
1. ğŸ”„ é•¿æœŸè®°å¿†é›†æˆï¼ˆLangMemï¼‰
2. ğŸ”„ ä¸ªæ€§åŒ–æ¨èå¼•æ“
3. ğŸ”„ å¯¹è¯å¼äº¤äº’
4. ğŸ”„ å¥åº·è¶‹åŠ¿åˆ†æ

### é˜¶æ®µ3ï¼šç”Ÿæ€å®Œå–„ (8-10å‘¨)
1. â³ ç§»åŠ¨ç«¯å¼€å‘ï¼ˆUniAppï¼‰
2. â³ ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ
3. â³ æ•°æ®å¯¼å‡ºåŠŸèƒ½
4. â³ ç¤¾äº¤åˆ†äº«åŠŸèƒ½

### é˜¶æ®µ4ï¼šè§„æ¨¡åŒ–éƒ¨ç½² (4-6å‘¨)
1. â³ å¾®æœåŠ¡æ‹†åˆ†
2. â³ å®¹å™¨åŒ–éƒ¨ç½²
3. â³ ç›‘æ§è¿ç»´ä½“ç³»
4. â³ æ€§èƒ½ä¼˜åŒ–

## ğŸ’¡ åˆ›æ–°ç‰¹æ€§å»ºè®®

### 1. AIé©±åŠ¨çš„é¢„æµ‹æ€§å¥åº·ç®¡ç†
- åŸºäºå†å²æ•°æ®é¢„æµ‹ç”¨æˆ·å¥åº·è¶‹åŠ¿
- æå‰é¢„è­¦æ½œåœ¨å¥åº·é£é™©
- æ™ºèƒ½è°ƒæ•´é¥®é£Ÿå»ºè®®

### 2. ç¤¾äº¤åŒ–å¥åº·ç®¡ç†
- å®¶åº­å¥åº·ç®¡ç†åŠŸèƒ½
- å¥åº·æŒ‘æˆ˜å’Œæ¿€åŠ±æœºåˆ¶
- ä¸“ä¸šè¥å…»å¸ˆåœ¨çº¿å’¨è¯¢


### 3. IoTè®¾å¤‡é›†æˆ
- æ™ºèƒ½ä½“é‡ç§¤æ•°æ®åŒæ­¥
- è¿åŠ¨æ‰‹ç¯æ•°æ®æ•´åˆ
- æ™ºèƒ½å¨æˆ¿è®¾å¤‡è”åŠ¨

### 4. AR/VRä½“éªŒ
- ARé£Ÿç‰©è¯†åˆ«å’Œè¥å…»å±•ç¤º
- VRè™šæ‹Ÿè¥å…»æ•™è‚²
- 3Dé£Ÿç‰©å»ºæ¨¡å’Œåˆ†é‡ä¼°ç®—

è¿™ä¸ªæ¶æ„è®¾è®¡ä¸ºDietAgentæä¾›äº†ä¸€ä¸ªå¯æ‰©å±•ã€é«˜æ€§èƒ½ã€æ™ºèƒ½åŒ–çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚å»ºè®®æŒ‰ç…§å®æ–½è·¯çº¿å›¾é€æ­¥å¼€å‘ï¼Œä¼˜å…ˆå®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå†é€æ­¥å¢åŠ æ™ºèƒ½åŒ–ç‰¹æ€§ã€‚ 

## ğŸ§© æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡ä¸å®ç°æ€è·¯

### 1. è‡ªå®šä¹‰å¥åº·è§„åˆ™å¼•æ“

#### è®¾è®¡æ€è·¯
- **è§„åˆ™é©±åŠ¨æ¶æ„**ï¼šé‡‡ç”¨è§„åˆ™å¼•æ“æ¨¡å¼ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œçƒ­æ›´æ–°
- **å¤šç»´åº¦è§„åˆ™ä½“ç³»**ï¼šç–¾ç—…ã€ç›®æ ‡ã€è¿‡æ•ã€ä¸ªäººåå¥½å¤šç»´åº¦è§„åˆ™
- **æ™ºèƒ½æ¨ç†æœºåˆ¶**ï¼šç»“åˆä¸“å®¶çŸ¥è¯†å’ŒAIå­¦ä¹ çš„æ··åˆæ¨ç†

#### å®ç°æ–¹æ¡ˆ
```python
# rules_engine/core.py
class RuleEngine:
    """å¥åº·è§„åˆ™å¼•æ“æ ¸å¿ƒ"""
    
    def __init__(self):
        self.rule_chains = {
            'disease_rules': DiseaseRuleChain(),
            'goal_rules': GoalRuleChain(), 
            'allergy_rules': AllergyRuleChain(),
            'preference_rules': PreferenceRuleChain()
        }
    
    def evaluate_food(self, food_item: FoodItem, user_profile: UserProfile):
        """é£Ÿç‰©è¯„ä¼°ä¸»æµç¨‹"""
        evaluation_result = EvaluationResult()
        
        for chain_name, rule_chain in self.rule_chains.items():
            result = rule_chain.evaluate(food_item, user_profile)
            evaluation_result.merge(result)
        
        return evaluation_result

# ç–¾ç—…è§„åˆ™é“¾ç¤ºä¾‹
class DiseaseRuleChain:
    def __init__(self):
        self.rules = {
            'diabetes': DiabetesRule(),
            'hypertension': HypertensionRule(),
            'kidney_disease': KidneyDiseaseRule()
        }
    
    def evaluate(self, food_item, user_profile):
        results = []
        for disease in user_profile.diseases:
            if disease.code in self.rules:
                rule = self.rules[disease.code]
                result = rule.apply(food_item, disease.severity)
                results.append(result)
        return self._aggregate_results(results)
```

#### è§„åˆ™é…ç½®ç³»ç»Ÿ
```yaml
# config/disease_rules.yaml
diabetes:
  nutrients_to_watch:
    carbohydrates:
      warning_threshold: 45  # æ¯é¤ç¢³æ°´>45gè­¦å‘Š
      danger_threshold: 60   # æ¯é¤ç¢³æ°´>60gå±é™©
    sugar:
      warning_threshold: 15
      danger_threshold: 25
  
  recommended_foods:
    - "å…¨éº¦é£Ÿå“"
    - "è”¬èœç±»"
    - "ç˜¦è‚‰è›‹ç™½"
  
  foods_to_avoid:
    - "é«˜ç³–é¥®æ–™"
    - "ç³–æœç”œç‚¹"
    - "ç™½ç±³ç™½é¢"

hypertension:
  nutrients_to_watch:
    sodium:
      warning_threshold: 800  # æ¯é¤é’ >800mgè­¦å‘Š
      danger_threshold: 1200
```

### 2. å›¾ç‰‡è¯†åˆ«ä¸è¥å…»åˆ†ææ¨¡å—

#### å¤šæ¨¡æ€AIè¯†åˆ«æµç¨‹
```python
# ai_analysis/vision_pipeline.py
class FoodVisionPipeline:
    """é£Ÿç‰©è§†è§‰è¯†åˆ«ç®¡é“"""
    
    def __init__(self):
        self.detector = FoodDetector()      # é£Ÿç‰©æ£€æµ‹
        self.classifier = FoodClassifier()  # é£Ÿç‰©åˆ†ç±»
        self.estimator = PortionEstimator() # åˆ†é‡ä¼°ç®—
        self.nutrition_db = NutritionDB()   # è¥å…»æ•°æ®åº“
    
    async def analyze_image(self, image_data: bytes) -> FoodAnalysisResult:
        # 1. é£Ÿç‰©æ£€æµ‹ä¸åˆ†å‰²
        detected_foods = await self.detector.detect(image_data)
        
        # 2. é£Ÿç‰©åˆ†ç±»è¯†åˆ«
        classified_foods = []
        for food_region in detected_foods:
            food_type = await self.classifier.classify(food_region)
            portion = await self.estimator.estimate_portion(food_region)
            classified_foods.append({
                'type': food_type,
                'confidence': food_type.confidence,
                'portion_grams': portion,
                'bbox': food_region.bbox
            })
        
        # 3. è¥å…»æˆåˆ†è®¡ç®—
        nutrition_analysis = await self._calculate_nutrition(classified_foods)
        
        return FoodAnalysisResult(
            detected_foods=classified_foods,
            nutrition_facts=nutrition_analysis,
            analysis_confidence=self._calculate_overall_confidence(classified_foods)
        )
```

#### è¥å…»è®¡ç®—å¼•æ“ï¼ˆè¿™ä¸ªä¸é‡‡ç”¨ï¼Œå…·ä½“é€»è¾‘æ”¾åœ¨Agentä¸­ï¼‰
```python
# nutrition/calculator.py
class NutritionCalculator:
    """è¥å…»æˆåˆ†è®¡ç®—å™¨"""
    
    def calculate_meal_nutrition(self, food_items: List[FoodItem]) -> NutritionSummary:
        """è®¡ç®—æ•´é¤è¥å…»æˆåˆ†"""
        total_nutrition = NutritionFacts()
        
        for item in food_items:
            # ä»æ•°æ®åº“è·å–100gè¥å…»æˆåˆ†
            base_nutrition = self.nutrition_db.get_nutrition(item.food_code)
            
            # æŒ‰å®é™…é‡é‡è®¡ç®—
            actual_nutrition = self._scale_nutrition(
                base_nutrition, 
                item.weight_grams / 100
            )
            
            total_nutrition += actual_nutrition
        
        return NutritionSummary(
            total_nutrition=total_nutrition,
            macronutrient_ratios=self._calculate_ratios(total_nutrition),
            vitamin_coverage=self._assess_vitamin_coverage(total_nutrition)
        )
```

### 3. æ™ºèƒ½è®°å½•ä¸æ‰“å¡ç³»ç»Ÿ

#### å¤šæ¨¡å¼è®°å½•æ”¯æŒ
```python
# recording/recorder.py
class FoodRecorder:
    """é£Ÿç‰©è®°å½•å™¨"""
    
    def __init__(self):
        self.image_processor = ImageProcessor()
        self.voice_processor = VoiceProcessor()
        self.manual_input = ManualInputHandler()
        self.barcode_scanner = BarcodeScanner()
    
    async def record_food(self, record_request: RecordRequest) -> RecordResult:
        """ç»Ÿä¸€è®°å½•å…¥å£"""
        if record_request.type == RecordType.IMAGE:
            return await self._record_by_image(record_request)
        elif record_request.type == RecordType.VOICE:
            return await self._record_by_voice(record_request)
        elif record_request.type == RecordType.MANUAL:
            return await self._record_manually(record_request)
        elif record_request.type == RecordType.BARCODE:
            return await self._record_by_barcode(record_request)
    
    async def _record_by_voice(self, request):
        """è¯­éŸ³è®°å½•å¤„ç†"""
        # è¯­éŸ³è½¬æ–‡å­—
        text = await self.voice_processor.speech_to_text(request.audio_data)
        
        # NLPæå–é£Ÿç‰©ä¿¡æ¯
        food_entities = await self._extract_food_entities(text)
        
        # ç”Ÿæˆè®°å½•
        return await self._create_record_from_entities(food_entities, request.user_id)
```

#### æ™ºèƒ½æé†’ç³»ç»Ÿ
```python
# reminders/smart_reminder.py
class SmartReminderSystem:
    """æ™ºèƒ½æé†’ç³»ç»Ÿ"""
    
    def __init__(self):
        self.scheduler = CeleryScheduler()
        self.user_behavior_analyzer = UserBehaviorAnalyzer()
    
    async def schedule_personalized_reminders(self, user_id: int):
        """ä¸ªæ€§åŒ–æé†’è°ƒåº¦"""
        user_patterns = await self.user_behavior_analyzer.analyze(user_id)
        
        # åŸºäºç”¨æˆ·ä¹ æƒ¯è®¾ç½®æé†’
        meal_times = user_patterns.typical_meal_times
        for meal_type, typical_time in meal_times.items():
            # åœ¨ç”¨é¤å‰30åˆ†é’Ÿæé†’
            reminder_time = typical_time - timedelta(minutes=30)
            
            self.scheduler.schedule_daily_task(
                user_id=user_id,
                task_type=f"meal_reminder_{meal_type}",
                execution_time=reminder_time,
                message=self._generate_personalized_message(user_id, meal_type)
            )
```

### 4. å¯¹è¯å¼äº¤äº’ä¸æ¸è¿›å¼æé—®

#### å¯¹è¯ç®¡ç†ç³»ç»Ÿ
```python
# conversation/manager.py
class ConversationManager:
    """å¯¹è¯ç®¡ç†å™¨"""
    
    def __init__(self):
        self.intent_classifier = IntentClassifier()
        self.context_manager = ContextManager()
        self.response_generator = ResponseGenerator()
        self.memory_manager = MemoryManager()
    
    async def process_message(self, user_id: int, message: str, session_id: str):
        """å¤„ç†ç”¨æˆ·æ¶ˆæ¯"""
        # 1. æ„å›¾è¯†åˆ«
        intent = await self.intent_classifier.classify(message)
        
        # 2. ä¸Šä¸‹æ–‡ç®¡ç†
        context = await self.context_manager.get_context(user_id, session_id)
        context.add_user_message(message, intent)
        
        # 3. ç”Ÿæˆå“åº”
        response = await self.response_generator.generate(
            intent=intent,
            context=context,
            user_profile=await self._get_user_profile(user_id)
        )
        
        # 4. æ›´æ–°è®°å¿†
        await self.memory_manager.update_conversation_memory(
            user_id, session_id, message, response
        )
        
        return response

# æ„å›¾åˆ†ç±»ç¤ºä¾‹
class IntentClassifier:
    INTENTS = {
        'food_inquiry': ['è¿™ä¸ªèƒ½åƒå—', 'å¯ä»¥åƒä»€ä¹ˆ', 'ä»Šå¤©åƒä»€ä¹ˆ'],
        'nutrition_question': ['è¥å…»æˆåˆ†', 'çƒ­é‡å¤šå°‘', 'å«ç³–é‡'],
        'cooking_advice': ['æ€ä¹ˆåš', 'çƒ¹é¥ªæ–¹æ³•', 'é£Ÿè°±'],
        'health_consultation': ['å¥åº·å—', 'å¯¹èº«ä½“å¥½å—', 'ä¼šä¸ä¼š']
    }
```

#### æ¸è¿›å¼æé—®å¼•æ“
```python
# conversation/progressive_questioning.py
class ProgressiveQuestioningEngine:
    """æ¸è¿›å¼æé—®å¼•æ“"""
    
    def __init__(self):
        self.question_trees = self._load_question_trees()
        self.user_info_collector = UserInfoCollector()
    
    async def generate_follow_up_question(self, user_id: int, current_topic: str):
        """ç”Ÿæˆåç»­é—®é¢˜"""
        # è·å–ç”¨æˆ·å·²çŸ¥ä¿¡æ¯
        known_info = await self.user_info_collector.get_known_info(user_id)
        
        # é€‰æ‹©é—®é¢˜æ ‘
        question_tree = self.question_trees[current_topic]
        
        # æ‰¾åˆ°ä¸‹ä¸€ä¸ªåˆé€‚çš„é—®é¢˜
        next_question = question_tree.get_next_question(known_info)
        
        return next_question
    
    def _load_question_trees(self):
        """åŠ è½½é—®é¢˜æ ‘é…ç½®"""
        return {
            'dietary_assessment': DietaryAssessmentTree(),
            'health_goals': HealthGoalsTree(),
            'lifestyle_analysis': LifestyleAnalysisTree()
        }

# é—®é¢˜æ ‘ç¤ºä¾‹
class DietaryAssessmentTree:
    def __init__(self):
        self.questions = {
            'root': "æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„é¥®é£Ÿä¹ æƒ¯ï¼Œæ‚¨å¹³æ—¶å–œæ¬¢åƒä»€ä¹ˆç±»å‹çš„é£Ÿç‰©ï¼Ÿ",
            'cuisine_preference': {
                'question': "æ‚¨æ›´åçˆ±ä¸­å¼ã€è¥¿å¼è¿˜æ˜¯å…¶ä»–é£å‘³çš„æ–™ç†ï¼Ÿ",
                'next': ['spice_level', 'cooking_method']
            },
            'spice_level': {
                'question': "æ‚¨èƒ½æ¥å—å¤šè¾£çš„é£Ÿç‰©ï¼Ÿ(1-5çº§)",
                'next': ['cooking_method']
            },
            'cooking_method': {
                'question': "æ‚¨æ›´å–œæ¬¢æ¸…æ·¡çš„çƒ¹é¥ªæ–¹å¼è¿˜æ˜¯é‡å£å‘³çš„ï¼Ÿ",
                'next': ['meal_frequency']
            }
        }
```

### 5. å†å²æ•°æ®åˆ†æä¸ä»£è°¢è®¡ç®—

#### ä»£è°¢ç‡è®¡ç®—å¼•æ“
```python
# metabolism/calculator.py
class MetabolismCalculator:
    """ä»£è°¢ç‡è®¡ç®—å™¨"""
    
    def calculate_bmr(self, user_profile: UserProfile) -> float:
        """åŸºç¡€ä»£è°¢ç‡è®¡ç®—"""
        if user_profile.gender == Gender.MALE:
            # Harris-Benedictå…¬å¼ (ç”·æ€§)
            bmr = 88.362 + (13.397 * user_profile.weight) + \
                  (4.799 * user_profile.height) - (5.677 * user_profile.age)
        else:
            # Harris-Benedictå…¬å¼ (å¥³æ€§)
            bmr = 447.593 + (9.247 * user_profile.weight) + \
                  (3.098 * user_profile.height) - (4.330 * user_profile.age)
        
        return bmr
    
    def calculate_tdee(self, bmr: float, activity_level: ActivityLevel) -> float:
        """æ€»æ—¥èƒ½é‡æ¶ˆè€—è®¡ç®—"""
        activity_multipliers = {
            ActivityLevel.SEDENTARY: 1.2,
            ActivityLevel.LIGHT: 1.375,
            ActivityLevel.MODERATE: 1.55,
            ActivityLevel.ACTIVE: 1.725,
            ActivityLevel.VERY_ACTIVE: 1.9
        }
        return bmr * activity_multipliers[activity_level]
    
    def analyze_metabolism_trend(self, user_id: int, days: int = 30):
        """ä»£è°¢è¶‹åŠ¿åˆ†æ"""
        # è·å–å†å²æ•°æ®
        history = self._get_user_history(user_id, days)
        
        # è®¡ç®—ä»£è°¢æŒ‡æ ‡
        metrics = []
        for record in history:
            daily_intake = record.total_calories
            estimated_expenditure = self._estimate_daily_expenditure(record)
            metabolic_rate = self._calculate_metabolic_efficiency(
                daily_intake, estimated_expenditure, record.weight_change
            )
            metrics.append(metabolic_rate)
        
        return MetabolismTrendAnalysis(
            average_rate=np.mean(metrics),
            trend_direction=self._calculate_trend(metrics),
            recommendations=self._generate_metabolism_recommendations(metrics)
        )
```

#### æ™ºèƒ½æ•°æ®æŒ–æ˜
```python
# analytics/data_mining.py
class NutritionDataMiner:
    """è¥å…»æ•°æ®æŒ–æ˜å™¨"""
    
    def __init__(self):
        self.pattern_detector = PatternDetector()
        self.correlation_analyzer = CorrelationAnalyzer()
        self.anomaly_detector = AnomalyDetector()
    
    async def mine_user_patterns(self, user_id: int) -> UserPatternInsights:
        """æŒ–æ˜ç”¨æˆ·è¡Œä¸ºæ¨¡å¼"""
        # è·å–ç”¨æˆ·æ•°æ®
        user_data = await self._get_comprehensive_user_data(user_id)
        
        # æ¨¡å¼æ£€æµ‹
        eating_patterns = self.pattern_detector.detect_eating_patterns(user_data)
        health_correlations = self.correlation_analyzer.find_correlations(user_data)
        anomalies = self.anomaly_detector.detect_anomalies(user_data)
        
        return UserPatternInsights(
            eating_patterns=eating_patterns,
            health_correlations=health_correlations,
            anomalies=anomalies,
            actionable_insights=self._generate_insights(
                eating_patterns, health_correlations, anomalies
            )
        )
    
    def detect_eating_patterns(self, user_data):
        """æ£€æµ‹é¥®é£Ÿæ¨¡å¼"""
        patterns = {}
        
        # æ—¶é—´æ¨¡å¼
        patterns['meal_timing'] = self._analyze_meal_timing(user_data.meals)
        
        # é£Ÿç‰©åå¥½æ¨¡å¼
        patterns['food_preferences'] = self._analyze_food_preferences(user_data.meals)
        
        # è¥å…»æ‘„å…¥æ¨¡å¼
        patterns['nutrition_patterns'] = self._analyze_nutrition_patterns(user_data.nutrition)
        
        # å‘¨æœŸæ€§æ¨¡å¼
        patterns['cyclical_patterns'] = self._analyze_cyclical_patterns(user_data)
        
        return patterns
```

### 6. å¥åº·åº¦è¯„ä¼°ä¸é¢„è­¦ç³»ç»Ÿ

#### ç»¼åˆå¥åº·è¯„åˆ†æ¨¡å‹
```python
# health_assessment/scorer.py
class HealthScoreCalculator:
    """å¥åº·è¯„åˆ†è®¡ç®—å™¨"""
    
    def __init__(self):
        self.scoring_models = {
            'nutrition_balance': NutritionBalanceScorer(),
            'dietary_variety': DietaryVarietyScorer(),
            'meal_regularity': MealRegularityScorer(),
            'hydration_status': HydrationScorer(),
            'metabolic_health': MetabolicHealthScorer()
        }
        
        # æƒé‡å¯æ ¹æ®ç”¨æˆ·ç‰¹å¾åŠ¨æ€è°ƒæ•´
        self.base_weights = {
            'nutrition_balance': 0.35,
            'dietary_variety': 0.20,
            'meal_regularity': 0.15,
            'hydration_status': 0.15,
            'metabolic_health': 0.15
        }
    
    def calculate_comprehensive_score(self, user_id: int, assessment_period: int = 7):
        """è®¡ç®—ç»¼åˆå¥åº·è¯„åˆ†"""
        user_data = self._get_user_data(user_id, assessment_period)
        user_profile = self._get_user_profile(user_id)
        
        # æ ¹æ®ç”¨æˆ·ç‰¹å¾è°ƒæ•´æƒé‡
        weights = self._adjust_weights_for_user(self.base_weights, user_profile)
        
        scores = {}
        for component, scorer in self.scoring_models.items():
            scores[component] = scorer.calculate_score(user_data, user_profile)
        
        # åŠ æƒè®¡ç®—æ€»åˆ†
        total_score = sum(scores[comp] * weights[comp] for comp in scores)
        
        return HealthScore(
            total_score=total_score,
            component_scores=scores,
            trend_analysis=self._analyze_score_trend(user_id),
            improvement_suggestions=self._generate_improvement_suggestions(scores)
        )

# è¥å…»å¹³è¡¡è¯„åˆ†å™¨ç¤ºä¾‹
class NutritionBalanceScorer:
    def calculate_score(self, user_data, user_profile):
        """è®¡ç®—è¥å…»å¹³è¡¡è¯„åˆ†"""
        daily_summaries = user_data.daily_summaries
        
        balance_scores = []
        for summary in daily_summaries:
            # å®é‡è¥å…»ç´ æ¯”ä¾‹è¯„åˆ†
            macro_score = self._score_macronutrient_balance(summary)
            
            # å¾®é‡è¥å…»ç´ å……è¶³åº¦è¯„åˆ†
            micro_score = self._score_micronutrient_adequacy(summary)
            
            # çƒ­é‡å¹³è¡¡è¯„åˆ†
            calorie_score = self._score_calorie_balance(summary, user_profile)
            
            daily_score = (macro_score * 0.4 + micro_score * 0.3 + calorie_score * 0.3)
            balance_scores.append(daily_score)
        
        return np.mean(balance_scores)
```

#### æ™ºèƒ½é¢„è­¦ç³»ç»Ÿ
```python
# alerts/warning_system.py
class HealthWarningSystem:
    """å¥åº·é¢„è­¦ç³»ç»Ÿ"""
    
    def __init__(self):
        self.risk_assessors = {
            'nutrition_deficiency': NutritionDeficiencyAssessor(),
            'chronic_disease_risk': ChronicDiseaseRiskAssessor(),
            'eating_disorder_risk': EatingDisorderRiskAssessor(),
            'metabolic_syndrome_risk': MetabolicSyndromeAssessor()
        }
        
        self.notification_service = NotificationService()
    
    async def assess_health_risks(self, user_id: int):
        """è¯„ä¼°å¥åº·é£é™©"""
        user_data = await self._get_comprehensive_user_data(user_id)
        user_profile = await self._get_user_profile(user_id)
        
        risk_assessments = {}
        alerts_to_send = []
        
        for risk_type, assessor in self.risk_assessors.items():
            risk_level, details = assessor.assess_risk(user_data, user_profile)
            risk_assessments[risk_type] = {
                'level': risk_level,
                'details': details,
                'confidence': details.confidence
            }
            
            # ç”Ÿæˆå¿…è¦çš„é¢„è­¦
            if risk_level >= RiskLevel.MEDIUM:
                alert = self._create_alert(risk_type, risk_level, details)
                alerts_to_send.append(alert)
        
        # å‘é€é¢„è­¦é€šçŸ¥
        for alert in alerts_to_send:
            await self.notification_service.send_health_alert(user_id, alert)
        
        return HealthRiskAssessment(
            risk_assessments=risk_assessments,
            overall_risk_level=self._calculate_overall_risk(risk_assessments),
            recommendations=self._generate_risk_mitigation_recommendations(risk_assessments)
        )

# è¥å…»ç¼ºä¹é£é™©è¯„ä¼°å™¨ç¤ºä¾‹
class NutritionDeficiencyAssessor:
    def assess_risk(self, user_data, user_profile):
        """è¯„ä¼°è¥å…»ç¼ºä¹é£é™©"""
        recent_intake = user_data.recent_nutrition_summary  # æœ€è¿‘7å¤©
        recommended_intake = self._get_recommended_intake(user_profile)
        
        deficiencies = []
        overall_risk = RiskLevel.LOW
        
        for nutrient, recommended in recommended_intake.items():
            actual = recent_intake.get(nutrient, 0)
            adequacy_ratio = actual / recommended
            
            if adequacy_ratio < 0.5:  # ä¸¥é‡ä¸è¶³
                deficiencies.append({
                    'nutrient': nutrient,
                    'severity': 'severe',
                    'adequacy_ratio': adequacy_ratio
                })
                overall_risk = max(overall_risk, RiskLevel.HIGH)
            elif adequacy_ratio < 0.7:  # ä¸è¶³
                deficiencies.append({
                    'nutrient': nutrient,
                    'severity': 'moderate',
                    'adequacy_ratio': adequacy_ratio
                })
                overall_risk = max(overall_risk, RiskLevel.MEDIUM)
        
        return overall_risk, DeficiencyDetails(
            deficiencies=deficiencies,
            confidence=self._calculate_confidence(user_data),
            recommendations=self._generate_deficiency_recommendations(deficiencies)
        )
```

### 7. ç¤¾äº¤ä¸æ¿€åŠ±ç³»ç»Ÿ

#### ç¤¾äº¤åŒ–å¥åº·ç®¡ç†
```python
# social/family_health.py
class FamilyHealthManager:
    """å®¶åº­å¥åº·ç®¡ç†"""
    
    def __init__(self):
        self.family_analyzer = FamilyPatternAnalyzer()
        self.group_recommender = GroupRecommendationEngine()
    
    async def create_family_group(self, creator_id: int, family_members: List[int]):
        """åˆ›å»ºå®¶åº­å¥åº·å°ç»„"""
        family_group = FamilyGroup(
            creator_id=creator_id,
            members=family_members,
            shared_goals=await self._identify_shared_goals(family_members),
            group_settings=await self._initialize_group_settings(family_members)
        )
        
        # åˆ†æå®¶åº­é¥®é£Ÿæ¨¡å¼
        family_patterns = await self.family_analyzer.analyze_family_patterns(family_members)
        
        # ç”Ÿæˆå®¶åº­å¥åº·è®¡åˆ’
        family_plan = await self._generate_family_health_plan(family_group, family_patterns)
        
        return family_group, family_plan
    
    async def generate_family_meal_recommendations(self, family_group_id: int):
        """ç”Ÿæˆå®¶åº­é¤é£Ÿæ¨è"""
        members = await self._get_family_members(family_group_id)
        
        # è€ƒè™‘æ‰€æœ‰æˆå‘˜çš„å¥åº·éœ€æ±‚
        combined_requirements = self._combine_health_requirements(members)
        
        # ç”Ÿæˆé€‚åˆå…¨å®¶çš„é¤é£Ÿæ¨è
        meal_recommendations = await self.group_recommender.recommend_family_meals(
            combined_requirements
        )
        
        return meal_recommendations

# å¥åº·æŒ‘æˆ˜ç³»ç»Ÿ
class HealthChallengeSystem:
    """å¥åº·æŒ‘æˆ˜ç³»ç»Ÿ"""
    
    def create_challenge(self, challenge_type: str, participants: List[int], duration: int):
        """åˆ›å»ºå¥åº·æŒ‘æˆ˜"""
        challenge_templates = {
            'water_intake': WaterIntakeChallenge(),
            'vegetable_variety': VegetableVarietyChallenge(),
            'cooking_frequency': CookingFrequencyChallenge(),
            'meal_regularity': MealRegularityChallenge()
        }
        
        challenge = challenge_templates[challenge_type].create(
            participants=participants,
            duration=duration,
            start_date=datetime.now()
        )
        
        return challenge
```

### 8. IoTè®¾å¤‡é›†æˆæ¡†æ¶

#### è®¾å¤‡è¿æ¥ä¸æ•°æ®åŒæ­¥
```python
# iot/device_integration.py
class IoTDeviceManager:
    """IoTè®¾å¤‡ç®¡ç†å™¨"""
    
    def __init__(self):
        self.device_connectors = {
            'smart_scale': SmartScaleConnector(),
            'fitness_tracker': FitnessTrackerConnector(),
            'smart_kitchen': SmartKitchenConnector(),
            'water_bottle': SmartWaterBottleConnector()
        }
        
        self.data_synchronizer = DataSynchronizer()
    
    async def connect_device(self, user_id: int, device_type: str, device_config: dict):
        """è¿æ¥IoTè®¾å¤‡"""
        connector = self.device_connectors[device_type]
        
        # è®¾å¤‡è®¤è¯å’Œé…å¯¹
        device = await connector.authenticate_and_pair(device_config)
        
        # æ³¨å†Œè®¾å¤‡åˆ°ç”¨æˆ·è´¦æˆ·
        await self._register_device_to_user(user_id, device)
        
        # å¯åŠ¨æ•°æ®åŒæ­¥
        await self.data_synchronizer.start_sync(device)
        
        return device
    
    async def sync_device_data(self, device_id: str):
        """åŒæ­¥è®¾å¤‡æ•°æ®"""
        device = await self._get_device(device_id)
        connector = self.device_connectors[device.type]
        
        # è·å–è®¾å¤‡æ•°æ®
        raw_data = await connector.fetch_data(device)
        
        # æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–
        cleaned_data = await self._clean_and_standardize_data(raw_data, device.type)
        
        # å­˜å‚¨åˆ°æ•°æ®åº“
        await self._store_device_data(device.user_id, cleaned_data)
        
        # è§¦å‘ç›¸å…³åˆ†æ
        await self._trigger_analysis_updates(device.user_id, cleaned_data)

# æ™ºèƒ½ä½“é‡ç§¤è¿æ¥å™¨ç¤ºä¾‹
class SmartScaleConnector:
    async def fetch_data(self, device):
        """è·å–ä½“é‡ç§¤æ•°æ®"""
        # è¿æ¥è®¾å¤‡API
        scale_data = await self._connect_to_scale_api(device.api_credentials)
        
        return ScaleData(
            weight=scale_data['weight'],
            body_fat_percentage=scale_data.get('body_fat'),
            muscle_mass=scale_data.get('muscle_mass'),
            bone_mass=scale_data.get('bone_mass'),
            water_percentage=scale_data.get('water_percentage'),
            timestamp=scale_data['measured_at']
        )
```

### 9. AR/VRä½“éªŒæ¨¡å—

#### ARé£Ÿç‰©è¯†åˆ«ä¸å±•ç¤º
```python
# ar_vr/ar_experience.py
class ARFoodExperience:
    """ARé£Ÿç‰©ä½“éªŒ"""
    
    def __init__(self):
        self.ar_renderer = ARRenderer()
        self.nutrition_visualizer = NutritionVisualizer()
        self.portion_estimator = AR3DPortionEstimator()
    
    async def render_nutrition_overlay(self, camera_feed, food_detection_result):
        """æ¸²æŸ“è¥å…»ä¿¡æ¯å åŠ å±‚"""
        # ä¸ºæ¯ä¸ªæ£€æµ‹åˆ°çš„é£Ÿç‰©åˆ›å»ºARæ ‡ç­¾
        ar_elements = []
        
        for food_item in food_detection_result.detected_foods:
            # åˆ›å»º3Dè¥å…»ä¿¡æ¯å¡ç‰‡
            nutrition_card = await self.nutrition_visualizer.create_3d_card(
                food_item.nutrition_facts
            )
            
            # å®šä½åˆ°é£Ÿç‰©ä½ç½®
            positioned_card = self.ar_renderer.position_element(
                nutrition_card,
                world_position=food_item.world_coordinates
            )
            
            ar_elements.append(positioned_card)
        
        # æ¸²æŸ“ARåœºæ™¯
        ar_scene = self.ar_renderer.compose_scene(camera_feed, ar_elements)
        
        return ar_scene
    
    async def estimate_3d_portion(self, food_item, reference_objects):
        """3Dåˆ†é‡ä¼°ç®—"""
        # ä½¿ç”¨å‚è€ƒç‰©ä½“ï¼ˆå¦‚ç¡¬å¸ã€æ‰‹ç­‰ï¼‰è¿›è¡Œå°ºåº¦æ ¡å‡†
        scale_factor = self._calculate_scale_factor(reference_objects)
        
        # 3Dé‡å»ºé£Ÿç‰©æ¨¡å‹
        food_3d_model = await self._reconstruct_3d_model(food_item)
        
        # è®¡ç®—å®é™…ä½“ç§¯å’Œé‡é‡
        volume = self._calculate_volume(food_3d_model, scale_factor)
        estimated_weight = self._estimate_weight_from_volume(volume, food_item.density)
        
        return PortionEstimate(
            volume_ml=volume,
            weight_grams=estimated_weight,
            confidence=self._calculate_estimation_confidence(food_3d_model)
        )

# VRè¥å…»æ•™è‚²æ¨¡å—
class VRNutritionEducation:
    """VRè¥å…»æ•™è‚²"""
    
    def __init__(self):
        self.vr_environment = VREnvironment()
        self.interactive_lessons = InteractiveLessonEngine()
    
    async def create_nutrition_lesson(self, lesson_topic: str, user_level: str):
        """åˆ›å»ºVRè¥å…»è¯¾ç¨‹"""
        lesson_content = await self.interactive_lessons.generate_lesson(
            topic=lesson_topic,
            difficulty_level=user_level
        )
        
        # åˆ›å»ºVRç¯å¢ƒ
        vr_scene = self.vr_environment.create_kitchen_scene()
        
        # æ·»åŠ äº¤äº’å¼é£Ÿæ
        interactive_ingredients = self._create_interactive_ingredients(lesson_content.ingredients)
        vr_scene.add_objects(interactive_ingredients)
        
        # æ·»åŠ è™šæ‹Ÿè¥å…»å¸ˆæŒ‡å¯¼
        virtual_nutritionist = self._create_virtual_guide(lesson_content.guidance)
        vr_scene.add_character(virtual_nutritionist)
        
        return VRLesson(
            scene=vr_scene,
            learning_objectives=lesson_content.objectives,
            interactive_tasks=lesson_content.tasks
        )
```

## ğŸ”„ ç³»ç»Ÿé›†æˆä¸æ•°æ®æµ

### æ•°æ®æµæ¶æ„å›¾ï¼ˆå¾®æœåŠ¡ä¸é‡‡ç”¨ï¼‰
```mermaid
graph TB
    A[ç”¨æˆ·è¾“å…¥] --> B[APIç½‘å…³]
    B --> C[è´Ÿè½½å‡è¡¡å™¨]
    C --> D[å¾®æœåŠ¡é›†ç¾¤]
    
    D --> E[ç”¨æˆ·æœåŠ¡]
    D --> F[AIåˆ†ææœåŠ¡]
    D --> G[è®°å½•æœåŠ¡]
    D --> H[å¥åº·è¯„ä¼°æœåŠ¡]
    
    F --> I[LangGraph Agent]
    I --> J[è§†è§‰æ¨¡å‹]
    I --> K[è¯­è¨€æ¨¡å‹]
    
    E --> L[PostgreSQL]
    G --> L
    H --> L
    
    F --> M[Redisç¼“å­˜]
    G --> N[MinIOå¯¹è±¡å­˜å‚¨]
    H --> O[ClickHouseåˆ†æåº“]
    
    I --> P[LangMemè®°å¿†]
    I --> Q[Milvuså‘é‡åº“]
    
    R[IoTè®¾å¤‡] --> S[è®¾å¤‡ç½‘å…³]
    S --> G
    
    T[ç¬¬ä¸‰æ–¹API] --> U[APIé€‚é…å™¨]
    U --> D
```

### äº‹ä»¶é©±åŠ¨æ¶æ„
```python
# events/event_system.py
class EventBus:
    """äº‹ä»¶æ€»çº¿"""
    
    def __init__(self):
        self.subscribers = defaultdict(list)
        self.message_broker = RabbitMQBroker()
    
    def subscribe(self, event_type: str, handler: Callable):
        """è®¢é˜…äº‹ä»¶"""
        self.subscribers[event_type].append(handler)
    
    async def publish(self, event: Event):
        """å‘å¸ƒäº‹ä»¶"""
        # æœ¬åœ°å¤„ç†
        for handler in self.subscribers[event.type]:
            await handler(event)
        
        # è·¨æœåŠ¡ä¼ æ’­
        await self.message_broker.publish(event.type, event.data)

# äº‹ä»¶å®šä¹‰
@dataclass
class FoodRecordCreatedEvent(Event):
    type = "food_record_created"
    user_id: int
    record_id: int
    food_data: dict
    timestamp: datetime

@dataclass 
class HealthScoreUpdatedEvent(Event):
    type = "health_score_updated"
    user_id: int
    new_score: float
    previous_score: float
    change_reason: str

# äº‹ä»¶å¤„ç†å™¨ç¤ºä¾‹
class NutritionAnalysisEventHandler:
    async def handle_food_record_created(self, event: FoodRecordCreatedEvent):
        """å¤„ç†é£Ÿç‰©è®°å½•åˆ›å»ºäº‹ä»¶"""
        # è§¦å‘è¥å…»åˆ†æ
        await self.nutrition_analyzer.analyze_async(event.record_id)
        
        # æ›´æ–°æ—¥æ€»ç»“
        await self.daily_summary_updater.update(event.user_id, event.timestamp.date())
        
        # æ£€æŸ¥å¥åº·é¢„è­¦
        await self.health_warning_system.check_warnings(event.user_id)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç¼“å­˜ç­–ç•¥
```python
# cache/strategy.py
class CacheStrategy:
    """ç¼“å­˜ç­–ç•¥"""
    
    def __init__(self):
        self.redis_client = RedisClient()
        self.memory_cache = MemoryCache()
    
    async def get_user_nutrition_summary(self, user_id: int, date: date):
        """è·å–ç”¨æˆ·è¥å…»æ±‡æ€»ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = f"nutrition_summary:{user_id}:{date}"
        
        # L1: å†…å­˜ç¼“å­˜
        cached_data = self.memory_cache.get(cache_key)
        if cached_data:
            return cached_data
        
        # L2: Redisç¼“å­˜
        cached_data = await self.redis_client.get(cache_key)
        if cached_data:
            # å›å¡«L1ç¼“å­˜
            self.memory_cache.set(cache_key, cached_data, ttl=300)
            return cached_data
        
        # L3: æ•°æ®åº“æŸ¥è¯¢
        data = await self._fetch_from_database(user_id, date)
        
        # æ›´æ–°ç¼“å­˜
        await self.redis_client.setex(cache_key, 3600, data)  # 1å°æ—¶
        self.memory_cache.set(cache_key, data, ttl=300)       # 5åˆ†é’Ÿ
        
        return data

# å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–
class AsyncTaskOptimizer:
    """å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–å™¨"""
    
    def __init__(self):
        self.task_queue = CeleryQueue()
        self.batch_processor = BatchProcessor()
    
    async def optimize_nutrition_analysis(self, food_records: List[FoodRecord]):
        """æ‰¹é‡ä¼˜åŒ–è¥å…»åˆ†æ"""
        # æŒ‰ç›¸ä¼¼æ€§åˆ†ç»„
        grouped_records = self._group_by_similarity(food_records)
        
        # æ‰¹é‡å¤„ç†ç›¸ä¼¼é£Ÿç‰©
        for group in grouped_records:
            await self.batch_processor.process_similar_foods(group)
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†ä¸å®¹é”™æœºåˆ¶

### æœåŠ¡å®¹é”™è®¾è®¡
```python
# resilience/circuit_breaker.py
class CircuitBreaker:
    """ç†”æ–­å™¨"""
    
    def __init__(self, failure_threshold=5, timeout=60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.failure_count = 0
        self.last_failure_time = None
        self.state = "CLOSED"  # CLOSED, OPEN, HALF_OPEN
    
    async def call(self, func, *args, **kwargs):
        """è°ƒç”¨å—ä¿æŠ¤çš„å‡½æ•°"""
        if self.state == "OPEN":
            if time.time() - self.last_failure_time > self.timeout:
                self.state = "HALF_OPEN"
            else:
                raise CircuitBreakerOpenException()
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise e
    
    def _on_success(self):
        self.failure_count = 0
        self.state = "CLOSED"
    
    def _on_failure(self):
        self.failure_count += 1
        self.last_failure_time = time.time()
        
        if self.failure_count >= self.failure_threshold:
            self.state = "OPEN"

# ä¼˜é›…é™çº§
class GracefulDegradation:
    """ä¼˜é›…é™çº§"""
    
    async def get_nutrition_analysis_with_fallback(self, food_image):
        """å¸¦é™çº§çš„è¥å…»åˆ†æ"""
        try:
            # å°è¯•AIåˆ†æ
            return await self.ai_analyzer.analyze(food_image)
        except AIServiceUnavailableException:
            # é™çº§åˆ°åŸºç¡€è¯†åˆ«
            return await self.basic_analyzer.analyze(food_image)
        except Exception:
            # æœ€ç»ˆé™çº§åˆ°æ‰‹åŠ¨è¾“å…¥æç¤º
            return self._generate_manual_input_suggestion()
```

è¿™ä¸ªå®Œå–„çš„ç³»ç»Ÿæ¶æ„è®¾è®¡æ¶µç›–äº†ä½ è‰ç¨¿ä¸­æåˆ°çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶ä¸”æä¾›äº†å…·ä½“çš„å®ç°æ€è·¯å’ŒæŠ€æœ¯æ–¹æ¡ˆã€‚æ•´ä¸ªæ¶æ„å…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§ã€å®¹é”™æ€§å’Œæ™ºèƒ½åŒ–ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ”¯æ’‘ä¸€ä¸ªå®Œæ•´çš„AIè¥å…»å¸ˆåº”ç”¨çš„è¿è¡Œã€‚ 